<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>ComputerUse</title>
</head>
<body>
    <div id="inputForm">
        <input type="text" id="name" value="Test_Run" />
        <input type="text" id="targetUrl" value="nytimes.com" />
        <select id="aiModel">
            <option value="anthropic" selected>Anthropic</option>
            <option value="gpt4">Gpt 4</option>
        </select>
        <input type="text" id="message" value="Open first top art article." />
        
        <input type="button" id="sendBtn" value="Send" disabled="disabled" />
    </div>
    <ul id="chatroom"></ul>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
    <script>
        var baseUrl = "https://cu-agent-bfecbtfqg3adaten.polandcentral-01.azurewebsites.net";

        const hubConnection = new signalR.HubConnectionBuilder()
            .withUrl(baseUrl + "/messages")
            .build();
 
        document.getElementById("sendBtn").addEventListener("click", function () {
            let name = document.getElementById("name").value;
            let targetUrl = document.getElementById("targetUrl").value;
            const aiModel = document.getElementById("aiModel").value
            let message = document.getElementById("message").value;
            
                var testRun = {
                    name,
                    targetUrl,
                    aiModel,
                    steps: [message]
                };

                hubConnection
                    //.stream("Test", testRun)
                    .stream("StartNewTestRun", testRun)
                    .subscribe({
        next: (item) => {
            var outerLi = document.createElement("li");
            var innerList = document.createElement("ul");

            var innerLi = document.createElement("li");
            innerLi.textContent = '-------------------------------------------------------------';
            innerList.appendChild(innerLi);
            
            innerLi = document.createElement("li");
            innerLi.textContent = 'Role:' + item.role;
            innerList.appendChild(innerLi);

            item.content.forEach(content => {
                innerLi = document.createElement("li");

                if (content.$type === 'text') {
                    innerLi.textContent = 'Text:' + content.text;
                } else if (content.$type === 'base64Image') {
                    var image = document.createElement("img");
                    image.src = "data:" + content.mediaType + ";base64," + content.data;
                    innerLi.appendChild(image);
                } else {
                    innerLi.textContent = 'Unknown Content!';
                }
                innerList.appendChild(innerLi);
            });

            outerLi.appendChild(innerList);
            document.getElementById("chatroom").appendChild(outerLi);
        },
        complete: () => {
            var li = document.createElement("li");
            li.textContent = "Stream completed";
            document.getElementById("chatroom").appendChild(li);
        },
        error: (err) => {
            var li = document.createElement("li");
            li.textContent = err;
            document.getElementById("chatroom").appendChild(li);
        },
})
        });

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
 
        async function waitUntilLoading() {
            const url = baseUrl + "/Agent/Ping";
            var isLoaded = false;

            while(!isLoaded) {
                try {
                const response = await fetch(url);

                if (response.ok) {
                    isLoaded = true;
                } else {
                    await sleep(2000);
                }
                } catch (error) {
                    console.error(error.message);
                    await sleep(2000);
                }
            }

            hubConnection.start()
            .then(function () {
                document.getElementById("sendBtn").disabled = false;
            })
            .catch(function (err) {
                return console.error(err.toString());
            });
        }

        (async () => {
            await waitUntilLoading();
            console.log('App loaded!');
        })();
        
        
    </script>
</body>
</html>